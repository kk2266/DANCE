<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixelated Tie-Dye Spiral</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rampart+One&family=Zen+Dots&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    min-height: 100vh;
    overflow: hidden;
    background: #111;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Zen Dots', 'Courier New', monospace;
  }
  canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }
  .content {
    position: relative;
    z-index: 10;
    text-align: center;
    color: white;
    text-shadow: 0 0 20px rgba(0,0,0,0.8), 0 0 40px rgba(0,0,0,0.6);
  }
  .content h1 {
    font-family: 'Rampart One', 'Zen Dots', cursive;
    font-size: clamp(2rem, 6vw, 5rem);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 0.5em;
    animation: glow 3s ease-in-out infinite alternate;
  }
  .content p {
    font-size: clamp(0.9rem, 2vw, 1.4rem);
    opacity: 0.85;
    letter-spacing: 0.3em;
  }
  @keyframes glow {
    from { text-shadow: 0 0 20px rgba(255,255,255,0.3), 0 0 40px rgba(0,0,0,0.6); }
    to   { text-shadow: 0 0 30px rgba(255,255,255,0.6), 0 0 60px rgba(150,50,255,0.4); }
  }
  .controls {
    position: fixed;
    bottom: 20px; right: 20px;
    z-index: 20;
    display: flex; gap: 8px;
  }
  .controls button {
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.15);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'Zen Dots', 'Courier New', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    transition: all 0.2s;
  }
  .controls button:hover {
    background: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.3);
  }
  .controls button.active {
    background: rgba(255,255,255,0.25);
    border-color: rgba(255,255,255,0.5);
  }

  /* Music notes */
  .music-note {
    position: fixed;
    z-index: 15;
    font-size: 2rem;
    pointer-events: none;
    opacity: 0;
    animation: noteFloat 3s ease-out forwards;
  }
  @keyframes noteFloat {
    0%   { opacity: 1; transform: translateY(0) rotate(0deg) scale(1); }
    50%  { opacity: 0.8; }
    100% { opacity: 0; transform: translateY(-200px) rotate(30deg) scale(0.3); }
  }

  /* Diamond sparkles */
  .diamond {
    position: fixed;
    z-index: 15;
    pointer-events: none;
    opacity: 0;
    animation: diamondPop 1.4s ease-out forwards;
  }
  .diamond::before, .diamond::after {
    content: '';
    position: absolute;
    background: currentColor;
  }
  .diamond::before {
    width: 100%;
    height: 2px;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    border-radius: 1px;
    box-shadow: 0 0 6px currentColor;
  }
  .diamond::after {
    width: 2px;
    height: 100%;
    left: 50%;
    top: 0;
    transform: translateX(-50%);
    border-radius: 1px;
    box-shadow: 0 0 6px currentColor;
  }
  .diamond-inner {
    position: absolute;
    inset: 30%;
    background: currentColor;
    transform: rotate(45deg);
    box-shadow: 0 0 8px currentColor, 0 0 16px currentColor;
  }
  @keyframes diamondPop {
    0%   { opacity: 0; transform: scale(0) rotate(0deg); }
    20%  { opacity: 1; transform: scale(1.2) rotate(20deg); }
    50%  { opacity: 0.9; transform: scale(0.9) rotate(45deg); }
    100% { opacity: 0; transform: scale(0.3) rotate(90deg); }
  }

  /* Music player bar */
  .player-bar {
    margin-top: 30px;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 10px 16px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px 10px;
    min-width: 320px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }
  .player-top {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    justify-content: center;
  }
  .player-bottom {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
  }
  .player-bar button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 0.85rem;
    padding: 2px 4px;
    line-height: 1;
    transition: transform 0.15s, opacity 0.15s;
    opacity: 0.8;
    font-family: inherit;
    letter-spacing: 0.05em;
  }
  .player-bar button:hover {
    transform: scale(1.1);
    opacity: 1;
  }
  .player-title {
    font-size: 0.6rem;
    color: rgba(255,255,255,0.7);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 90px;
    letter-spacing: 0.05em;
  }
  .player-time {
    font-size: 0.6rem;
    color: rgba(255,255,255,0.5);
    min-width: 32px;
    text-align: center;
    user-select: none;
  }
  .player-slider-wrap {
    flex: 1;
    display: flex;
    align-items: center;
  }
  .player-slider-wrap input[type=range] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 4px;
    border-radius: 2px;
    background: rgba(255,255,255,0.15);
    outline: none;
    cursor: pointer;
  }
  .player-slider-wrap input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: white;
    box-shadow: 0 0 6px rgba(255,255,255,0.4);
    cursor: pointer;
  }
  .player-slider-wrap input[type=range]::-moz-range-thumb {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: white;
    border: none;
    box-shadow: 0 0 6px rgba(255,255,255,0.4);
    cursor: pointer;
  }
  .volume-wrap {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .volume-wrap input[type=range] {
    -webkit-appearance: none;
    appearance: none;
    width: 50px;
    height: 3px;
    border-radius: 2px;
    background: rgba(255,255,255,0.2);
    outline: none;
    cursor: pointer;
  }
  .volume-wrap input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: white;
    cursor: pointer;
  }
  .volume-wrap input[type=range]::-moz-range-thumb {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: white;
    border: none;
    cursor: pointer;
  }

  /* Sidebar */
  .sidebar-toggle {
    position: fixed;
    top: 16px; left: 16px;
    z-index: 30;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.15);
    color: white;
    font-size: 1.2rem;
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Zen Dots', 'Courier New', monospace;
  }
  .sidebar-toggle.shifted {
    left: 296px;
  }
  .sidebar-toggle:hover {
    background: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.3);
  }
  .sidebar {
    position: fixed;
    top: 0; left: 0;
    width: 280px;
    height: 100vh;
    z-index: 25;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(16px);
    border-right: 1px solid rgba(255,255,255,0.1);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
    font-family: 'Zen Dots', 'Courier New', monospace;
  }
  .sidebar.open {
    transform: translateX(0);
  }
  .sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    color: white;
    font-family: 'Rampart One', 'Zen Dots', cursive;
    font-size: 1rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }
  .sidebar-header button {
    background: none;
    border: none;
    color: rgba(255,255,255,0.6);
    font-size: 1.3rem;
    cursor: pointer;
    padding: 2px 6px;
    transition: color 0.2s;
  }
  .sidebar-header button:hover {
    color: white;
  }
  .track-list {
    list-style: none;
    overflow-y: auto;
    flex: 1;
    padding: 8px 0;
  }
  .track-list li {
    padding: 10px 16px;
    color: rgba(255,255,255,0.65);
    font-size: 0.72rem;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.03em;
    border-left: 3px solid transparent;
  }
  .track-list li:hover {
    background: rgba(255,255,255,0.06);
    color: white;
  }
  .track-list li.active {
    color: white;
    background: rgba(255,255,255,0.08);
    border-left-color: rgba(150,50,255,0.7);
  }
  .track-list li.album-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: rgba(200,170,255,0.85);
    font-size: 0.74rem;
  }
  .track-list li.album-item:hover {
    color: rgb(200,170,255);
  }
  .album-icon {
    font-size: 0.9rem;
    flex-shrink: 0;
  }
  .sidebar-back {
    background: none;
    border: none;
    color: rgba(255,255,255,0.5);
    font-family: 'Zen Dots', 'Courier New', monospace;
    font-size: 0.65rem;
    cursor: pointer;
    padding: 8px 16px;
    text-align: left;
    transition: color 0.15s;
    letter-spacing: 0.05em;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .sidebar-back:hover {
    color: white;
  }

  /* Player nav buttons */
  .player-bar .nav-btn {
    font-size: 0.7rem;
    opacity: 0.65;
  }
  .player-bar .nav-btn:hover {
    opacity: 1;
  }
  .player-bar .shuffle-btn.active {
    color: rgb(150,50,255);
    opacity: 1;
  }
</style>
</head>
<body>
<canvas id="spiral"></canvas>

<audio id="music" src="tracks/PSY - GENTLEMAN M_V.mp3" preload="auto"></audio>

<button class="sidebar-toggle" onclick="toggleSidebar()">&#9776;</button>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <span>Tracks</span>
    <button onclick="toggleSidebar()">&times;</button>
  </div>
  <ul class="track-list" id="trackList"></ul>
</div>

<div class="content">
  <img id="dancer" src="deal-with-it-trailblazer.gif" alt="Deal With It Trailblazer" style="max-width:200px; transition: none;">
  <div class="player-bar">
    <div class="player-top">
      <button class="nav-btn" onclick="prevTrack()" title="Previous">&#9664;&#9664;</button>
      <button id="playBtn" onclick="togglePlay()" title="Play/Pause">&#9654;&#65039;</button>
      <button class="nav-btn" onclick="nextTrack()" title="Next">&#9654;&#9654;</button>
      <button class="nav-btn shuffle-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Shuffle">&#8645;</button>
      <span class="player-title" id="trackTitle">PSY - GENTLEMAN</span>
      <div class="volume-wrap">
        <button id="muteBtn" onclick="toggleMute()" title="Mute">&#9835;</button>
        <input type="range" id="volBar" min="0" max="1" value="1" step="0.01">
      </div>
    </div>
    <div class="player-bottom">
      <span class="player-time" id="curTime">0:00</span>
      <div class="player-slider-wrap">
        <input type="range" id="seekBar" min="0" max="100" value="0" step="0.1">
      </div>
      <span class="player-time" id="durTime">0:00</span>
    </div>
  </div>
<div class="controls">
  <button id="pixelBtn" onclick="togglePixel()">Pixel: 8px</button>
  <button id="speedBtn" onclick="toggleSpeed()">Speed: Normal</button>
  <button id="modeBtn" onclick="toggleMode()">Mode: Spiral</button>
  <button id="danceBtn" onclick="toggleDance()">Dance: Chill</button>
</div>
<script>
const canvas = document.getElementById('spiral');
const ctx = canvas.getContext('2d');

const colors = [
  [220,20,60],[255,69,0],[255,140,0],[255,200,0],[255,240,0],
  [120,220,20],[0,180,60],[0,180,180],[0,120,220],[30,60,200],
  [100,20,200],[180,20,160]
];
const N = colors.length;

let pixelSize=8, speed=1, mode='spiral', time=0;
const pixelSizes=[4,8,12,16]; let pi=1;
const speeds=[0.5,1,2]; let si=1;
const modes=['spiral','rings','vortex','random']; let mi=0;
const randomCycleDuration = 300; // frames per mode before transitioning

// Dance presets: { scale, rotation, bounceY, bounceX, freqMult }
const dancePresets = [
  { name:'Chill',   scale:0.04, rot:3,  bY:3,  bX:2,  freq:0.6  },
  { name:'Groove',  scale:0.08, rot:5,  bY:6,  bX:4,  freq:1.0  },
  { name:'Hyped',   scale:0.14, rot:10, bY:12, bX:8,  freq:1.6  },
  { name:'Chaos',   scale:0.22, rot:20, bY:24, bX:16, freq:2.5  },
];
let di=0, dance=dancePresets[0];

function resize(){
  canvas.width=Math.ceil(window.innerWidth/pixelSize);
  canvas.height=Math.ceil(window.innerHeight/pixelSize);
}
window.addEventListener('resize',resize); resize();

function getColor(v){
  // Use sin/cos to map value to palette position seamlessly (no seam)
  // This avoids modulo discontinuities
  const angle = v * Math.PI * 2;
  const s = (Math.sin(angle) * 0.5 + 0.5); // 0-1 smooth cycle
  const c = (Math.cos(angle) * 0.5 + 0.5); // 0-1 smooth cycle offset
  // Combine to get a smooth index that wraps without seams
  const idx = ((Math.atan2(Math.sin(angle), Math.cos(angle)) / (Math.PI * 2)) + 1) % 1;
  const pos = idx * N;
  const i = Math.floor(pos);
  const t = pos - i;
  const c1 = colors[i % N], c2 = colors[(i + 1) % N];
  return [c1[0]+(c2[0]-c1[0])*t, c1[1]+(c2[1]-c1[1])*t, c1[2]+(c2[2]-c1[2])*t];
}

function draw(){
  const w=canvas.width, h=canvas.height, cx=w/2, cy=h/2;
  const maxR=Math.sqrt(cx*cx+cy*cy);
  const img=ctx.createImageData(w,h), d=img.data;
  const t = time;

  for(let y=0;y<h;y++) for(let x=0;x<w;x++){
    const dx=x-cx, dy=y-cy;
    const dist=Math.sqrt(dx*dx+dy*dy);
    // Use sin/cos components to avoid atan2 discontinuity
    const sinA = dy / (dist + 0.001);
    const cosA = dx / (dist + 0.001);
    // Reconstruct angle in 0..1 range using atan2, then use trig for color
    const ang = Math.atan2(dy, dx); // -PI to PI

    // Compute each mode's v with integer arms (no seam)
    const noise = Math.sin(x * 0.7 + y * 1.3) * 0.015 + Math.sin(x * 1.1 - y * 0.9) * 0.01;
    const bright = 0.85 + 0.15 * Math.sin(dist * 0.05 + t * 0.01);

    const vSpiral = 1 * ang / (Math.PI * 2) + dist * 0.3 / maxR - t * 0.008 * speed
      + Math.sin(dist * 0.06 - t * 0.012 * speed) * 0.08 + noise;
    const vRings = dist / (maxR * 0.12) - t * 0.025 * speed
      + Math.sin(ang * 8 + t * 0.02 * speed) * 0.01 + noise;
    const vVortex = 3 * ang / (Math.PI * 2) + dist * 0.8 / maxR - t * 0.012 * speed
      + Math.sin(dist * 0.1 + t * 0.02) * 0.06
      + Math.cos(ang * 2 - t * 0.015) * 0.04 + noise;

    function vToRGB(val) {
      const phase = val * Math.PI * 2;
      const idx_s = ((Math.atan2(Math.sin(phase), Math.cos(phase)) / (Math.PI * 2)) + 1.0) % 1.0;
      const pos = idx_s * N;
      const ci = Math.floor(pos);
      const cf = pos - ci;
      const c1 = colors[ci % N], c2 = colors[(ci + 1) % N];
      return [
        Math.min(255, (c1[0]+(c2[0]-c1[0])*cf) * bright),
        Math.min(255, (c1[1]+(c2[1]-c1[1])*cf) * bright),
        Math.min(255, (c1[2]+(c2[2]-c1[2])*cf) * bright)
      ];
    }

    let r, g, b;
    if(mode==='random'){
      const allV = [vSpiral, vRings, vVortex];
      const cycle = t * speed / randomCycleDuration;
      const fromIdx = Math.floor(cycle) % 3;
      const toIdx = (fromIdx + 1) % 3;
      let blend = (cycle % 1);
      blend = blend * blend * (3 - 2 * blend);
      const cF = vToRGB(allV[fromIdx]);
      const cT = vToRGB(allV[toIdx]);
      // Power-curve crossfade: each pattern dims out/in, hiding muddy overlap
      const wF = (1 - blend) * (1 - blend);
      const wT = blend * blend;
      r = cF[0] * wF + cT[0] * wT;
      g = cF[1] * wF + cT[1] * wT;
      b = cF[2] * wF + cT[2] * wT;
    } else {
      const v = mode==='spiral'?vSpiral:mode==='rings'?vRings:vVortex;
      const c = vToRGB(v);
      r = c[0]; g = c[1]; b = c[2];
    }

    const p = (y * w + x) * 4;
    d[p]   = r;
    d[p+1] = g;
    d[p+2] = b;
    d[p+3] = 255;
  }

  ctx.putImageData(img, 0, 0);

  // Sync GIF dance to the same time/speed driving the spiral
  const dancer = document.getElementById('dancer');
  const f = dance.freq;
  const pulse = 1 + dance.scale * Math.sin(time * 0.06 * speed * f);
  const rot = dance.rot * Math.sin(time * 0.04 * speed * f);
  const bounceY = dance.bY * Math.sin(time * 0.08 * speed * f);
  const bounceX = dance.bX * Math.sin(time * 0.05 * speed * f + 1);
  dancer.style.transform =
    `translateY(${bounceY}px) translateX(${bounceX}px) scale(${pulse}) rotate(${rot}deg)`;

  time++;
  requestAnimationFrame(draw);
}

function togglePixel(){
  pi=(pi+1)%pixelSizes.length; pixelSize=pixelSizes[pi]; resize();
  document.getElementById('pixelBtn').textContent='Pixel: '+pixelSize+'px';
}
function toggleSpeed(){
  si=(si+1)%speeds.length; speed=speeds[si];
  document.getElementById('speedBtn').textContent='Speed: '+['Slow','Normal','Fast'][si];
}
function toggleMode(){
  mi=(mi+1)%modes.length; mode=modes[mi];
  document.getElementById('modeBtn').textContent='Mode: '+['Spiral','Rings','Vortex','Random'][mi];
}
function toggleDance(){
  di=(di+1)%dancePresets.length; dance=dancePresets[di];
  document.getElementById('danceBtn').textContent='Dance: '+dance.name;
}

// Track & album data
const library = {
  singles: [
    { file: "tracks/DAN DA DAN Season 2 ED _ Doukashiteru by WurtS _ Netflix Anime.mp3", title: "Doukashiteru - WurtS" },
    { file: "tracks/KANA-BOON - Silhouette.mp3", title: "KANA-BOON - Silhouette" },
    { file: "tracks/Kiminosei Remastered 2022.mp3", title: "Kiminosei Remastered 2022" },
    { file: "tracks/PSY - GENTLEMAN M_V.mp3", title: "PSY - GENTLEMAN" },
    { file: "tracks/RADWIMPS - movie ver Official Music Video.mp3", title: "RADWIMPS - Movie Ver" },
    { file: "tracks/stay with me.mp3", title: "Stay With Me" },
    { file: "tracks/the peggiesMusic Video.mp3", title: "The Peggies" },
  ],
  albums: [
    {
      name: "Graduation",
      tracks: [
        { file: "tracks/graduation/01 - Good Morning.mp3", title: "Good Morning" },
        { file: "tracks/graduation/02 - Champion.mp3", title: "Champion" },
        { file: "tracks/graduation/03 - Stronger.mp3", title: "Stronger" },
        { file: "tracks/graduation/04 - I Wonder.mp3", title: "I Wonder" },
        { file: "tracks/graduation/05 - Good Life feat. T-Pain.mp3", title: "Good Life ft. T-Pain" },
        { file: "tracks/graduation/06 - Cant Tell Me Nothing.mp3", title: "Can't Tell Me Nothing" },
        { file: "tracks/graduation/07 - Barry Bonds feat. Lil Wayne.mp3", title: "Barry Bonds ft. Lil Wayne" },
        { file: "tracks/graduation/08 - Drunk & Hot Girls feat. Mos Def.mp3", title: "Drunk & Hot Girls ft. Mos Def" },
        { file: "tracks/graduation/09 - Flashing Lights feat. Dwele.mp3", title: "Flashing Lights ft. Dwele" },
        { file: "tracks/graduation/10 - Everything I Am feat. DJ Premier.mp3", title: "Everything I Am ft. DJ Premier" },
        { file: "tracks/graduation/11 - The Glory.mp3", title: "The Glory" },
        { file: "tracks/graduation/12 - Homecoming.mp3", title: "Homecoming" },
        { file: "tracks/graduation/13 - Big Brother.mp3", title: "Big Brother" },
        { file: "tracks/graduation/14 - Good Night feat. Mos Def & Al Be.mp3", title: "Good Night ft. Mos Def & Al Be" },
        { file: "tracks/graduation/15 - Bittersweet Poetry feat. John Mayer.mp3", title: "Bittersweet Poetry ft. John Mayer" },
      ]
    }
  ]
};

// Flatten all tracks into a single playable list
const tracks = [...library.singles, ...library.albums.flatMap(a => a.tracks)];
let currentTrackIndex = 3; // PSY is default
let shuffleOn = false;
let shuffledOrder = [];
let shufflePos = 0;

// Audio playback
const music = document.getElementById('music');
const seekBar = document.getElementById('seekBar');
const volBar = document.getElementById('volBar');
const curTimeEl = document.getElementById('curTime');
const durTimeEl = document.getElementById('durTime');
let isPlaying = false, isSeeking = false;
let noteInterval = null;

function fmtTime(s){
  if(!isFinite(s)) return '0:00';
  const m = Math.floor(s/60);
  const sec = Math.floor(s%60);
  return m + ':' + (sec<10?'0':'') + sec;
}

function togglePlay(){
  const btn = document.getElementById('playBtn');
  if(isPlaying){
    music.pause();
    isPlaying = false;
    btn.textContent = '\u25B6';
    stopEffects();
  } else {
    music.play();
    isPlaying = true;
    btn.textContent = '\u2759\u2759';
    startEffects();
  }
}

function toggleMute(){
  music.muted = !music.muted;
  document.getElementById('muteBtn').textContent = music.muted ? '\u2022' : '\u266B';
}

// Track management
function loadTrack(index){
  const wasPlaying = isPlaying;
  currentTrackIndex = index;
  music.src = tracks[index].file;
  document.getElementById('trackTitle').textContent = tracks[index].title;
  highlightActiveTrack();
  if(wasPlaying){
    music.play();
  } else {
    isPlaying = false;
  }
}

function highlightActiveTrack(){
  const items = document.querySelectorAll('.track-list li[data-index]');
  items.forEach(li => {
    li.classList.toggle('active', parseInt(li.dataset.index) === currentTrackIndex);
  });
}

function getNextIndex(direction){
  if(shuffleOn && shuffledOrder.length){
    shufflePos = (shufflePos + direction + shuffledOrder.length) % shuffledOrder.length;
    return shuffledOrder[shufflePos];
  }
  return (currentTrackIndex + direction + tracks.length) % tracks.length;
}

function nextTrack(){
  loadTrack(getNextIndex(1));
  if(!isPlaying) togglePlay();
}

function prevTrack(){
  if(music.currentTime > 3){
    music.currentTime = 0;
    return;
  }
  loadTrack(getNextIndex(-1));
  if(!isPlaying) togglePlay();
}

function generateShuffledOrder(){
  shuffledOrder = tracks.map((_, i) => i);
  for(let i = shuffledOrder.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledOrder[i], shuffledOrder[j]] = [shuffledOrder[j], shuffledOrder[i]];
  }
  shufflePos = shuffledOrder.indexOf(currentTrackIndex);
}

function toggleShuffle(){
  shuffleOn = !shuffleOn;
  document.getElementById('shuffleBtn').classList.toggle('active', shuffleOn);
  if(shuffleOn) generateShuffledOrder();
}

// Sidebar
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.querySelector('.sidebar-toggle').classList.toggle('shifted');
}

function getTrackGlobalIndex(file){
  return tracks.findIndex(t => t.file === file);
}

function showMainList(){
  const ul = document.getElementById('trackList');
  ul.innerHTML = '';
  // Singles
  library.singles.forEach(t => {
    const li = document.createElement('li');
    const idx = getTrackGlobalIndex(t.file);
    li.textContent = t.title;
    li.dataset.index = idx;
    li.addEventListener('click', () => {
      loadTrack(idx);
      if(!isPlaying) togglePlay();
      toggleSidebar();
    });
    ul.appendChild(li);
  });
  // Albums
  library.albums.forEach(album => {
    const li = document.createElement('li');
    li.className = 'album-item';
    li.innerHTML = '<span class="album-icon">\uD83D\uDCBF</span>' + album.name;
    li.addEventListener('click', () => showAlbumList(album));
    ul.appendChild(li);
  });
  highlightActiveTrack();
}

function showAlbumList(album){
  const ul = document.getElementById('trackList');
  ul.innerHTML = '';
  // Back button
  const back = document.createElement('button');
  back.className = 'sidebar-back';
  back.textContent = '\u2190 Back';
  back.addEventListener('click', showMainList);
  ul.appendChild(back);
  // Album tracks
  album.tracks.forEach(t => {
    const li = document.createElement('li');
    const idx = getTrackGlobalIndex(t.file);
    li.textContent = t.title;
    li.dataset.index = idx;
    li.addEventListener('click', () => {
      loadTrack(idx);
      if(!isPlaying) togglePlay();
      toggleSidebar();
    });
    ul.appendChild(li);
  });
  highlightActiveTrack();
}

function buildTrackList(){
  showMainList();
}

// Seek bar
seekBar.addEventListener('input', ()=>{ isSeeking = true; });
seekBar.addEventListener('change', ()=>{
  music.currentTime = (seekBar.value / 100) * music.duration;
  isSeeking = false;
});
volBar.addEventListener('input', ()=>{ music.volume = volBar.value; });

music.addEventListener('loadedmetadata', ()=>{ durTimeEl.textContent = fmtTime(music.duration); });
music.addEventListener('timeupdate', ()=>{
  if(!isSeeking && isFinite(music.duration)){
    seekBar.value = (music.currentTime / music.duration) * 100;
    curTimeEl.textContent = fmtTime(music.currentTime);
  }
});
music.addEventListener('ended', ()=>{ nextTrack(); });

// Effects start/stop
function startEffects(){
  spawnNotes();
}
function stopEffects(){
  clearInterval(noteInterval); noteInterval = null;
}

// Floating music notes
const noteChars = ['\u266A','\u266B','\u266C','\u2669'];
function spawnNotes(){
  if(noteInterval) return;
  noteInterval = setInterval(()=>{
    const note = document.createElement('div');
    note.className = 'music-note';
    note.textContent = noteChars[Math.floor(Math.random()*noteChars.length)];
    note.style.left = (10 + Math.random()*80) + 'vw';
    note.style.bottom = (5 + Math.random()*15) + 'vh';
    note.style.color = `hsl(${Math.random()*360}, 80%, 70%)`;
    note.style.fontSize = (1.2 + Math.random()*1.5) + 'rem';
    document.body.appendChild(note);
    note.addEventListener('animationend', ()=> note.remove());
  }, 400);
}

// Diamond sparkles across screen
let diamondInterval = null;
function spawnDiamonds(){
  if(diamondInterval) return;
  diamondInterval = setInterval(()=>{
    const d = document.createElement('div');
    d.className = 'diamond';
    const size = 10 + Math.random() * 20;
    d.style.width = size + 'px';
    d.style.height = size + 'px';
    d.style.left = (5 + Math.random() * 90) + 'vw';
    d.style.top = (5 + Math.random() * 90) + 'vh';
    d.style.color = `hsl(${Math.random()*360}, 70%, 75%)`;
    const inner = document.createElement('div');
    inner.className = 'diamond-inner';
    d.appendChild(inner);
    document.body.appendChild(d);
    d.addEventListener('animationend', ()=> d.remove());
  }, 300);
}

buildTrackList();
spawnDiamonds();
draw();
</script>
</body>
</html>